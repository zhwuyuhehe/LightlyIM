import{d as Y,k as g,p as U,q as N,o as T,s as F,c as d,a as o,w as a,r as s,F as y,v as K,n as P,g as h,t as m,f as B,b as l,x as D,m as q,j as f,_ as A}from"./index-7JKY8DTR.js";import{u as I}from"./UseWebSocket-DqfMbmIh.js";import{_ as W}from"./ModificationComponents.vue_vue_type_script_setup_true_lang-BjiiL6mv.js";import{u as G}from"./user-CG2YVqeJ.js";import{P as J}from"./Interactive-NSA2erjS.js";const O={class:"chat-inner"},Q={class:"timestamp"},X=5,Z=Y({__name:"ChatView",setup(ee){const c=g(""),r=I(),$=G(),w=U(()=>[...r.systemMessages.map(e=>`[系统通知]${e}`)].join(`
`)),x=U(()=>[...r.messages.map(e=>`[${e.from_user}(${N(e.timestamp).format("YYYY年MM月DD日-HH时mm分ss秒")})]:${e.content}`)].join(`
`)),V=()=>{if(!c.value.trim())return;const e={type:"chat",content:c.value.trim()};r.sendMsg(e),c.value=""};function b(e){e.preventDefault()}T(()=>{r.connect(),window.addEventListener("beforeunload",b)}),F(()=>{r.disconnect(),window.removeEventListener("beforeunload",b)});const k=g([]);let M=0,_=!1,S=!1;const C=g(),j=e=>new Date(e).toLocaleTimeString();async function H(){var p;if(_||S)return;_=!0;const e=(p=C.value)==null?void 0:p.wrapRef,t=(e==null?void 0:e.scrollHeight)??0;try{const i=(await J.post("/chatHistory",{offset:M,limit:X})).data??[];if(i.length===0){S=!0;return}k.value.push(...i.reverse()),M+=i.length,await K();const v=(e==null?void 0:e.scrollHeight)??0;e.scrollTop+=v-t}catch(u){P.error("加载失败"+u)}finally{_=!1}}function z(e){e.target.scrollTop<10&&H()}return T(()=>{H()}),(e,t)=>{const p=s("el-header"),u=s("el-input"),i=s("el-main"),v=s("el-scrollbar"),E=s("el-aside"),R=s("el-container"),L=s("el-button");return f(),d(y,null,[o(R,null,{default:a(()=>[o(p,null,{default:a(()=>[h("欢迎"+m(B($).nickname)+"进入聊天室",1)]),_:1}),o(R,null,{default:a(()=>[o(i,null,{default:a(()=>[l("div",null,[o(u,{modelValue:w.value,"onUpdate:modelValue":t[0]||(t[0]=n=>w.value=n),type:"textarea",size:"large",autosize:{maxRows:16,minRows:8},readonly:""},null,8,["modelValue"])])]),_:1}),o(i,null,{default:a(()=>[l("div",null,[o(u,{modelValue:x.value,"onUpdate:modelValue":t[1]||(t[1]=n=>x.value=n),type:"textarea",size:"large",autosize:{maxRows:16,minRows:8},readonly:""},null,8,["modelValue"])]),o(v,{ref_key:"scrollbarRef",ref:C,class:"chat-container",onScroll:z},{default:a(()=>[l("div",O,[(f(!0),d(y,null,D(k.value,n=>(f(),d("div",{key:n.id,class:"chat-msg"},[l("div",null,[l("strong",null,m(n.from_user),1),h("："+m(n.content),1)]),l("div",Q,m(j(n.timestamp)),1)]))),128))])]),_:1},512)]),_:1}),o(E,null,{default:a(()=>[l("div",null,[t[3]||(t[3]=l("h2",null,"在线用户列表",-1)),l("ul",null,[(f(!0),d(y,null,D(B(r).onlineCount,n=>(f(),d("li",{key:n},m(n),1))),128))])])]),_:1})]),_:1}),o(u,{modelValue:c.value,"onUpdate:modelValue":t[2]||(t[2]=n=>c.value=n),type:"text",onKeyup:q(V,["enter"]),placeholder:"发送点什么吧！"},null,8,["modelValue"]),o(L,{onClick:V},{default:a(()=>t[4]||(t[4]=[h("发送")])),_:1})]),_:1}),o(W)],64)}}}),se=A(Z,[["__scopeId","data-v-cfca6c4c"]]);export{se as default};
