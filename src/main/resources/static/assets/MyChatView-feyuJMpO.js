import{d as $,k as d,p as I,y as R,o as W,z as G,e as H,w as s,n as g,r as l,a,b as r,c as _,x as T,f as h,F as N,g as b,t as f,A as J,B as O,C as Q,m as X,u as Z,j as c,D as ee,q as te,v as oe,_ as se}from"./index-7JKY8DTR.js";import{u as ae}from"./UseWebSocket-DqfMbmIh.js";import{u as ne}from"./user-CG2YVqeJ.js";import{P as U}from"./Interactive-NSA2erjS.js";const le={class:"chat-inner"},re={key:0,class:"no-more"},ce={class:"content"},ie={class:"meta"},ue={class:"from"},de={class:"time"},Y=20,_e=$({__name:"MyChatView",setup(fe){function k(e){e.preventDefault()}const q=Z(),i=ae(),y=ne(),L=async()=>{U.post("/logout").then(e=>{g.success(e.data.message),y.logout(),i.disconnect(),q.replace("/")}).catch(e=>{g.error(e)})},m=d("");function x(){const e=m.value.trim();e&&(i.sendMsg({type:"chat",content:e}),m.value="")}const C=d([]),M=I(()=>[...C.value,...i.messages]),w=d(null);R(M,async()=>{var t,n;await oe();const e=(n=(t=w.value)==null?void 0:t.$el)==null?void 0:n.querySelector(".el-scrollbar__wrap");e&&(e.scrollTop=e.scrollHeight)},{flush:"post"});let S=0;const u=d(!1),p=d(!1);async function V(){if(!(u.value||p.value)){u.value=!0;try{const t=(await U.post("/chatHistory",{offset:S,limit:Y})).data||[];t.length<Y&&(p.value=!0),C.value.unshift(...t.reverse()),S+=t.length}catch(e){g.error("加载历史失败："+e.message)}finally{u.value=!1}}}let D=0;function j(){var n,v;const e=Date.now();if(e-D<50)return;D=e;const t=(v=(n=w.value)==null?void 0:n.$el)==null?void 0:v.querySelector(".el-scrollbar__wrap");t&&t.scrollTop<=50&&!u.value&&!p.value&&V()}return W(async()=>{await V(),i.connect(),window.addEventListener("beforeunload",k)}),G(()=>{window.removeEventListener("beforeunload",k)}),(e,t)=>{const n=l("el-scrollbar"),v=l("el-aside"),z=l("el-header"),A=l("el-main"),F=l("el-input"),E=l("el-button"),K=l("el-footer"),B=l("el-container"),P=O("loading");return c(),H(B,{style:{height:"100vh"}},{default:s(()=>[a(v,{width:"200px",class:"aside"},{default:s(()=>[t[1]||(t[1]=r("h3",null,"在线用户",-1)),a(n,{style:{height:"calc(100% - 80px)"}},{default:s(()=>[r("ul",null,[(c(!0),_(N,null,T(h(i).onlineCount,o=>(c(),_("li",{key:o},f(o),1))),128))])]),_:1})]),_:1}),a(B,null,{default:s(()=>[a(z,null,{default:s(()=>[b("欢迎["+f(h(y).nickname)+"]加入聊天室",1)]),_:1}),a(A,{class:"chat-main"},{default:s(()=>[J((c(),H(n,{ref_key:"scrollbar",ref:w,class:"chat-container",onScroll:j,"element-loading-text":"正在加载历史消息..."},{default:s(()=>[r("div",le,[p.value?(c(),_("div",re,"没有更多历史了")):Q("",!0),(c(!0),_(N,null,T(M.value,o=>(c(),_("div",{key:o.timestamp+"-"+o.from_user,class:ee(["chat-msg",o.from_user===h(y).email?"mine":"other"])},[r("div",ce,f(o.content),1),r("div",ie,[r("span",ue,f(o.from_user),1),r("span",de,"("+f(h(te)(o.timestamp).format("YYYY年MM月DD日-HH时mm分ss秒"))+")",1)])],2))),128))])]),_:1})),[[P,u.value]])]),_:1}),a(K,{class:"chat-footer"},{default:s(()=>[a(F,{modelValue:m.value,"onUpdate:modelValue":t[0]||(t[0]=o=>m.value=o),placeholder:"按 Enter 发送消息",onKeyup:X(x,["enter"]),class:"chat-input"},null,8,["modelValue"]),a(E,{type:"primary",onClick:x},{default:s(()=>t[2]||(t[2]=[b("发送")])),_:1}),a(E,{type:"primary",onClick:L},{default:s(()=>t[3]||(t[3]=[b("退出")])),_:1})]),_:1})]),_:1})]),_:1})}}}),ye=se(_e,[["__scopeId","data-v-739bd2ad"]]);export{ye as default};
